# MP3外链盘

一个简洁优雅的MP3文件外链服务，支持在线播放链接生成。

## 功能特性

- 文件上传：支持MP3格式，最大5MB
- 外链生成：上传后即可获取在线播放链接
- 使用教程：提供5种常见的MP3外链使用场景和代码示例
- **自动清理**：超过24小时未被访问的文件自动删除，节省存储空间
- 访问追踪：实时记录文件访问情况，精准判断文件活跃度
- 防爆破机制：每个IP在60分钟内限制3次上传
- 管理后台：文件管理、删除功能、公告管理
- 公告系统：支持设置主页公告，强制阅读3秒后可关闭
- 中文支持：完美支持中文文件名，无乱码
- 安全设计：主页不显示管理入口，防止爆破攻击
- 毛玻璃UI：现代化的界面设计
- 丝滑动画：iOS风格的过渡效果

## 系统要求

- Ubuntu 20.04 或更高版本
- Node.js 14+ 
- npm 6+

## 快速部署

### 1. 克隆项目

```bash
git clone <repository-url>
cd 小懿mp3外链盘
```

### 2. 运行部署脚本

```bash
chmod +x deploy.sh
./deploy.sh
```

部署脚本会自动：
- 检测并安装缺失的依赖（Node.js, npm, PM2）
- 安装项目依赖包
- 配置管理员账户（默认用户名和密码均为admin）
- 询问运行端口（默认3000）
- 询问是否后台运行

### 3. 访问服务

- 主页：http://localhost:3000
- 使用教程：http://localhost:3000/tutorial.html
- 管理后台：http://localhost:3000/admin（主页不显示入口，直接访问此地址）

## 升级更新

运行升级脚本进行无感更新：

```bash
chmod +x upgrade.sh
./upgrade.sh
```

升级脚本会：
- 自动备份配置和数据
- 更新依赖包
- 平滑重启服务（使用PM2时）
- 保留所有上传的文件

## 常用命令

如果使用PM2后台运行：

```bash
# 查看服务状态
pm2 status

# 查看日志
pm2 logs mp3-hosting

# 重启服务
pm2 restart mp3-hosting

# 停止服务
pm2 stop mp3-hosting

# 删除服务
pm2 delete mp3-hosting
```

## 目录结构

```
.
├── server.js           # 后端服务器
├── package.json        # 项目依赖
├── config.json         # 配置文件（部署后生成）
├── deploy.sh          # 部署脚本
├── upgrade.sh         # 升级脚本
├── public/            # 前端文件
│   ├── index.html     # 主页
│   ├── tutorial.html  # 使用教程
│   ├── admin.html     # 管理后台
│   ├── style.css      # 样式文件
│   ├── script.js      # 主页脚本
│   └── admin.js       # 后台脚本
├── uploads/           # 上传文件存储（自动创建）
└── data/              # 数据文件（自动创建）
    ├── files.json     # 文件元数据
    ├── rate-limit.json # 限流数据
    ├── announcement.json # 公告内容
    └── access-log.json # 文件访问日志（自动清理功能）
```

## 技术栈

- 后端：Node.js + Express
- 前端：原生HTML/CSS/JavaScript
- 文件上传：Multer
- 会话管理：express-session
- 密码加密：bcryptjs
- 进程管理：PM2

## 配置说明

配置文件 `config.json` 在首次部署时自动生成：

```json
{
  "port": 3000,
  "admin": {
    "username": "admin",
    "password": "加密后的密码"
  },
  "rateLimit": {
    "enabled": true,
    "maxUploads": 3
  },
  "maxFileSize": 5
}
```

可以通过管理后台直接修改限流设置和文件大小限制，无需手动编辑配置文件。所有设置实时生效，前端会自动同步更新。

## 安全特性

- IP限流：防止恶意上传
- 隐藏入口：主页不显示管理后台入口，防止爆破
- 文件类型验证：仅允许MP3格式
- 文件大小限制：最大5MB
- 密码加密存储：使用bcrypt加密
- 会话管理：安全的管理员认证

## 管理功能

登录管理后台后，可以：

1. **文件管理**
   - 查看所有已上传的文件
   - 在线播放MP3文件
   - 删除不需要的文件
   - 查看统计信息（总文件数、总大小）

2. **公告管理**
   - 设置主页公告内容
   - 启用/禁用公告显示
   - 公告强制阅读3秒后可关闭
   - 支持多行文本

3. **限流设置**
   - 自定义每60分钟允许上传次数（1-999次）
   - 可完全关闭限流（测试时使用）
   - 实时生效，无需重启服务

4. **文件大小设置**
   - 自定义最大文件大小（1-100MB）
   - 修改后前端提示和验证自动同步更新
   - 支持灵活调整以适应不同需求

## 自动清理机制

系统内置智能文件管理功能，自动清理长期未使用的文件：

- **访问追踪**：每次文件被播放/下载时，自动更新最后访问时间
- **自动扫描**：每1小时自动检查一次所有文件的访问情况
- **智能清理**：超过24小时未被访问的文件会被自动删除
- **即时生效**：服务器启动时立即执行一次清理
- **日志输出**：所有清理操作都会输出到控制台日志

### 工作原理

1. **上传时**：文件上传成功后，系统记录初始访问时间
2. **访问时**：每次通过外链播放文件时，更新该文件的最后访问时间
3. **定时检查**：系统每小时自动扫描 `data/access-log.json`
4. **自动删除**：发现超过24小时未访问的文件，自动删除物理文件和数据库记录

### 日志示例

```
文件访问: 1234567890-abc123.mp3 (2024-01-01 12:00:00)
自动清理检查: 没有过期文件需要删除
已删除过期文件: old-file.mp3 (超过24小时未访问)
自动清理完成: 共删除 3 个过期文件
```

这个机制确保服务器存储空间始终保持在合理范围内，无需人工干预。

## 许可证

MIT License

## 支持

如有问题，请提交Issue。

